<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Draw Your Signature</title>
<script src="/public/qrcode.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f5f7fa;
    color: #1a1a2e;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 16px;
  }
  .container {
    max-width: 560px;
    width: 100%;
    margin: 0 auto;
  }
  h1 {
    color: #1a3c5e;
    font-size: 1.4rem;
    margin-bottom: 8px;
  }
  .subtitle {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 6px;
  }
  .instructions {
    color: #888;
    font-size: 0.85rem;
    line-height: 1.5;
    margin-bottom: 20px;
  }
  .section {
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .section-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #1a3c5e;
    margin-bottom: 10px;
  }
  .canvas-wrapper {
    position: relative;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    background: #fff;
    touch-action: none;
  }
  .canvas-wrapper.active { border-color: #1a3c5e; }
  canvas {
    display: block;
    width: 100%;
    cursor: crosshair;
  }
  .canvas-hint {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #aaa;
    font-size: 0.9rem;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .canvas-hint.hidden { opacity: 0; }
  .clear-btn {
    margin-top: 8px;
    background: none;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 8px 16px;
    font-size: 0.85rem;
    color: #666;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .clear-btn:hover { border-color: #999; color: #333; }
  .submit-btn {
    width: 100%;
    padding: 16px;
    background: #1a3c5e;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1.05rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    -webkit-tap-highlight-color: transparent;
    -webkit-appearance: none;
  }
  .submit-btn:hover:not(:disabled) { background: #245080; }
  .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .status {
    text-align: center;
    padding: 40px 20px;
  }
  .status.error { color: #c0392b; }
  .status.success { color: #1a3c5e; }
  .status h2 { margin-bottom: 8px; }
  .success-icon {
    font-size: 64px;
    color: #27ae60;
    margin-bottom: 16px;
  }
  .success-message {
    color: #666;
    margin-bottom: 24px;
  }
  .next-step {
    background: #f0f7ff;
    border: 2px solid #1a3c5e;
    border-radius: 8px;
    padding: 20px;
    margin: 24px 0;
  }
  .next-step-title {
    font-weight: 600;
    color: #1a3c5e;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }
  .next-step-action {
    font-size: 18px;
    color: #1a3c5e;
    font-weight: 500;
    margin: 0;
  }
  .spinner {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid #e2e8f0;
    border-top-color: #1a3c5e;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 12px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .hidden { display: none !important; }
  /* Driver's license upload */
  .dl-section { margin-bottom: 16px; }
  .dl-upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
  }
  .dl-upload-area:hover { border-color: #1a3c5e; background: #f8fafc; }
  .dl-upload-area.has-image { border-style: solid; border-color: #27ae60; cursor: default; }
  .dl-upload-icon { font-size: 2rem; margin-bottom: 8px; }
  .dl-upload-text { font-size: 0.9rem; color: #666; }
  .dl-upload-text strong { color: #1a3c5e; }
  .dl-preview { position: relative; display: inline-block; max-width: 100%; }
  .dl-preview img { max-width: 100%; max-height: 200px; border-radius: 4px; display: block; }
  .dl-remove-btn {
    position: absolute; top: 6px; right: 6px;
    background: rgba(0,0,0,0.6); color: #fff; border: none; border-radius: 50%;
    width: 28px; height: 28px; font-size: 1rem; cursor: pointer; line-height: 28px; text-align: center;
  }
  .dl-remove-btn:hover { background: rgba(192,57,43,0.9); }
  .dl-file-input { display: none; }
  .dl-optional { font-size: 0.75rem; color: #999; font-weight: 400; }
  /* QR desktop-to-mobile bridge */
  .qr-bridge { text-align: center; margin: 20px 0; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
  .qr-bridge svg { margin: 12px auto; display: block; max-width: 180px; max-height: 180px; }
  .qr-bridge-title { font-size: 0.85rem; font-weight: 600; color: #1a3c5e; margin-bottom: 4px; }
  .qr-bridge-subtitle { font-size: 0.8rem; color: #888; }
  .qr-divider { display: flex; align-items: center; gap: 12px; margin: 16px 0; color: #aaa; font-size: 0.8rem; }
  .qr-divider::before, .qr-divider::after { content: ''; flex: 1; border-top: 1px solid #e2e8f0; }
</style>
</head>
<body>
<div class="container">
  <!-- Loading state -->
  <div id="loading" class="status">
    <div class="spinner"></div>
    <p>Loading signing session...</p>
  </div>

  <!-- Error state -->
  <div id="error" class="status error hidden">
    <h2>Unable to Load</h2>
    <p id="error-message"></p>
  </div>

  <!-- Success state (only shown if auto-close failed) -->
  <div id="success" class="status success hidden">
    <div class="success-icon">âœ“</div>
    <h2>Signature Submitted Successfully</h2>
    <p class="success-message">Your signature has been securely encrypted and submitted.</p>
    <div class="next-step">
      <p class="next-step-title">You can close this tab now</p>
      <p class="next-step-action">Return to your AI assistant to continue.</p>
    </div>
  </div>

  <!-- Main signing form -->
  <div id="sign-form" class="hidden">
    <h1>Draw Your Signature</h1>
    <p class="subtitle" id="signer-greeting"></p>
    <p class="instructions" id="instructions-text"></p>

    <div class="section">
      <div class="section-label">Your Signature</div>
      <div class="canvas-wrapper" id="canvas-wrapper">
        <canvas id="sig-canvas" height="150"></canvas>
        <div class="canvas-hint" id="canvas-hint">Draw your signature here</div>
      </div>
      <button class="clear-btn" id="clear-btn">Clear</button>
    </div>

    <!-- Driver's license upload (shown conditionally) -->
    <div id="dl-section" class="section dl-section hidden">
      <div class="section-label">Driver's License <span class="dl-optional">(Optional)</span></div>
      <div id="dl-upload-area" class="dl-upload-area">
        <div class="dl-upload-icon">ðŸ“·</div>
        <div class="dl-upload-text"><strong>Tap to take a photo</strong> or upload an image</div>
      </div>
      <div id="dl-preview-wrapper" class="dl-preview hidden">
        <img id="dl-preview-img" alt="Driver's license preview">
        <button class="dl-remove-btn" id="dl-remove-btn" title="Remove">âœ•</button>
      </div>
      <input type="file" id="dl-file-input" class="dl-file-input" accept="image/*" capture="environment">
    </div>

    <!-- QR code bridge for desktop users -->
    <div id="qr-bridge" class="qr-bridge hidden">
      <div class="qr-bridge-title">ðŸ“± Or complete on your phone</div>
      <div class="qr-bridge-subtitle">Scan to sign &amp; capture your ID with your phone camera</div>
      <div id="qr-code"></div>
    </div>

    <button class="submit-btn" id="submit-btn" disabled>Submit Signature</button>
  </div>
</div>

<script>
(async () => {
  const $ = (s) => document.querySelector(s);
  const sessionId = window.location.pathname.split('/sign/')[1]?.split('?')[0];
  if (!sessionId) return showError('No session ID found in URL.');

  let serverPublicKey, instructions, signerName, requestDriversLicense;
  let hasDrawn = false;
  let dlDataUrl = null; // driver's license image data URL

  // --- Load session info ---
  try {
    const res = await fetch(`/api/signatures/sessions/${sessionId}/info`);
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      if (res.status === 410) return showError('This signing session has expired. Please request a new link.');
      if (res.status === 409) return showError('This authorization has already been signed.');
      return showError(err.error || 'Session not found.');
    }
    const data = await res.json();
    serverPublicKey = data.publicKeyJwk;
    instructions = data.instructions;
    signerName = data.signerName;
    requestDriversLicense = data.requestDriversLicense;
  } catch (e) {
    return showError('Could not connect to the server. Please try again.');
  }

  // --- Populate UI ---
  $('#instructions-text').textContent = instructions;
  if (signerName) {
    $('#signer-greeting').textContent = `Hello ${signerName}`;
  }
  $('#loading').classList.add('hidden');
  $('#sign-form').classList.remove('hidden');

  // --- Canvas setup ---
  const canvas = $('#sig-canvas');
  const ctx = canvas.getContext('2d');
  const wrapper = $('#canvas-wrapper');
  const dpr = Math.max(window.devicePixelRatio || 1, 2);

  function resizeCanvas() {
    const rect = wrapper.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = 150 * dpr;
    canvas.style.height = '150px';
    ctx.scale(dpr, dpr);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#1a1a2e';
  }
  resizeCanvas();
  window.addEventListener('resize', () => { resizeCanvas(); hasDrawn = false; updateSubmitState(); });

  let drawing = false;
  let lastX, lastY;

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
  }

  function startDraw(e) {
    e.preventDefault();
    drawing = true;
    const p = getPos(e);
    lastX = p.x; lastY = p.y;
    wrapper.classList.add('active');
    $('#canvas-hint').classList.add('hidden');
  }

  function draw(e) {
    if (!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    lastX = p.x; lastY = p.y;
    hasDrawn = true;
    updateSubmitState();
  }

  function endDraw(e) {
    if (e) e.preventDefault();
    drawing = false;
    wrapper.classList.remove('active');
  }

  canvas.addEventListener('pointerdown', startDraw);
  canvas.addEventListener('pointermove', draw);
  canvas.addEventListener('pointerup', endDraw);
  canvas.addEventListener('pointerleave', endDraw);

  $('#clear-btn').addEventListener('click', () => {
    ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
    hasDrawn = false;
    $('#canvas-hint').classList.remove('hidden');
    updateSubmitState();
  });

  // --- Driver's license upload (always available, optional) ---
  {
    $('#dl-section').classList.remove('hidden');
    const dlInput = $('#dl-file-input');
    const dlUploadArea = $('#dl-upload-area');
    const dlPreviewWrapper = $('#dl-preview-wrapper');
    const dlPreviewImg = $('#dl-preview-img');

    dlUploadArea.addEventListener('click', () => dlInput.click());

    function resizeImage(file, maxWidth) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          let w = img.width, h = img.height;
          if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
          const c = document.createElement('canvas');
          c.width = w; c.height = h;
          c.getContext('2d').drawImage(img, 0, 0, w, h);
          resolve(c.toDataURL('image/png'));
        };
        img.src = URL.createObjectURL(file);
      });
    }

    dlInput.addEventListener('change', async () => {
      const file = dlInput.files[0];
      if (!file) return;
      dlDataUrl = await resizeImage(file, 1600);
      dlPreviewImg.src = dlDataUrl;
      dlUploadArea.classList.add('hidden');
      dlPreviewWrapper.classList.remove('hidden');
    });

    $('#dl-remove-btn').addEventListener('click', () => {
      dlDataUrl = null;
      dlInput.value = '';
      dlPreviewWrapper.classList.add('hidden');
      dlUploadArea.classList.remove('hidden');
    });
  }

  // --- QR code bridge for desktop ---
  const isDesktop = !window.matchMedia('(pointer: coarse)').matches && window.innerWidth > 768;
  if (isDesktop) {
    $('#qr-bridge').classList.remove('hidden');
    QRCode.toString(window.location.href, { type: 'svg', margin: 2, color: { dark: '#1a3c5e' } }, (err, svg) => {
      if (svg) $('#qr-code').innerHTML = svg;
    });
    // Poll for session completion from another device
    (async () => {
      while (true) {
        await new Promise(r => setTimeout(r, 3000));
        try {
          const res = await fetch(`/api/signatures/sessions/${sessionId}/poll?timeout=1`);
          if (!res.ok) continue;
          const data = await res.json();
          if (data.status === 'completed') {
            $('#sign-form').classList.add('hidden');
            $('#success').classList.remove('hidden');
            return;
          }
          if (data.status === 'expired') {
            showError('This signing session has expired.');
            return;
          }
        } catch {}
      }
    })();
  }

  // --- Form validation ---
  function updateSubmitState() {
    $('#submit-btn').disabled = !hasDrawn;
  }

  // --- Submit with E2EE ---
  $('#submit-btn').addEventListener('click', async () => {
    $('#submit-btn').disabled = true;
    $('#submit-btn').textContent = 'Encrypting & Submitting...';

    try {
      // Crop to bounding box of drawn strokes (with padding)
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const { data, width, height } = imgData;
      let minX = width, minY = height, maxX = 0, maxY = 0;
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          if (data[(y * width + x) * 4 + 3] > 0) {
            if (x < minX) minX = x;
            if (x > maxX) maxX = x;
            if (y < minY) minY = y;
            if (y > maxY) maxY = y;
          }
        }
      }
      const pad = Math.round(8 * dpr);
      minX = Math.max(0, minX - pad);
      minY = Math.max(0, minY - pad);
      maxX = Math.min(width - 1, maxX + pad);
      maxY = Math.min(height - 1, maxY + pad);
      const cropW = maxX - minX + 1;
      const cropH = maxY - minY + 1;
      const cropped = ctx.getImageData(minX, minY, cropW, cropH);
      const tmpCanvas = document.createElement('canvas');
      tmpCanvas.width = cropW;
      tmpCanvas.height = cropH;
      tmpCanvas.getContext('2d').putImageData(cropped, 0, 0);
      const sigDataUrl = tmpCanvas.toDataURL('image/png');

      // Build payload
      const payloadObj = {
        signatureImage: sigDataUrl,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
      };
      if (dlDataUrl) payloadObj.driversLicenseImage = dlDataUrl;
      const payload = JSON.stringify(payloadObj);

      // Import server's public key
      const serverKey = await crypto.subtle.importKey(
        'jwk', serverPublicKey, { name: 'ECDH', namedCurve: 'P-256' }, false, []
      );

      // Generate ephemeral keypair
      const ephemeral = await crypto.subtle.generateKey(
        { name: 'ECDH', namedCurve: 'P-256' }, true, ['deriveBits']
      );

      // Derive shared secret
      const sharedBits = await crypto.subtle.deriveBits(
        { name: 'ECDH', public: serverKey }, ephemeral.privateKey, 256
      );

      // Use shared secret as AES-GCM key
      const aesKey = await crypto.subtle.importKey(
        'raw', sharedBits, 'AES-GCM', false, ['encrypt']
      );

      // Encrypt
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encrypted = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv }, aesKey, new TextEncoder().encode(payload)
      );

      // Export ephemeral public key
      const ephPubJwk = await crypto.subtle.exportKey('jwk', ephemeral.publicKey);

      // Submit
      const res = await fetch(`/api/signatures/sessions/${sessionId}/submit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ciphertext: bufToBase64(encrypted),
          iv: bufToBase64(iv),
          ephemeralPublicKey: ephPubJwk,
        }),
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || 'Submission failed');
      }

      // Try to auto-close the window
      window.close();
      
      // If we're still here, auto-close didn't work - show manual instructions
      $('#sign-form').classList.add('hidden');
      $('#success').classList.remove('hidden');
    } catch (e) {
      alert('Error submitting signature: ' + e.message);
      $('#submit-btn').disabled = false;
      $('#submit-btn').textContent = 'Submit Signature';
    }
  });

  // --- Helpers ---
  function showError(msg) {
    $('#loading').classList.add('hidden');
    $('#error-message').textContent = msg;
    $('#error').classList.remove('hidden');
  }

  function bufToBase64(buf) {
    return btoa(String.fromCharCode(...new Uint8Array(buf)));
  }
})();
</script>
</body>
</html>
